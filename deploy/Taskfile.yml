version: "3"

vars:
  CPU_START: "2"
  CPU_END: "11"

tasks:
  calclean:
    desc: Remove calibration files from root dist/
    cmds:
      - rm -rf ../dist/calibrations/*

  resources:
    desc: Create required docker network/volume for kingworker deploys
    cmds:
      - docker network create yow || true
      - docker volume create cal45 || true

  kingoneup:
    desc: Start one generated yowking service (yowking45)
    cmds:
      - docker compose -f compose-yowking.yaml up yowking45 -d

  kingup:
    desc: Start all generated yowking services
    cmds:
      - docker compose -f compose-yowking.yaml up -d

  kingdown:
    desc: Stop all generated yowking services
    cmds:
      - docker compose -f compose-yowking.yaml down

  compose-yowking.yaml:
    desc: Generate compose-yowking.yaml from CPU_START/CPU_END
    env:
      CPU_START: "{{.CPU_START}}"
      CPU_END: "{{.CPU_END}}"
    cmds:
      - node buildKingYaml.mjs

  cpuf:
    desc: Watch CPU frequency values
    cmds:
      - watch -n1 "grep '^[c]pu MHz' /proc/cpuinfo"

  cput:
    desc: Watch system temperatures (sensors)
    cmds:
      - watch -n .1 sensors

  cpusee:
    desc: Inspect CPU frequency and governor settings
    cmds:
      - cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_available_frequencies
      - cat /sys/devices/system/cpu/cpu2/cpufreq/scaling_available_governors
      - cat /sys/devices/system/cpu/cpu2/cpufreq/scaling_max_freq
      - cat /sys/devices/system/cpu/cpu3/cpufreq/scaling_max_freq
      - cat /sys/devices/system/cpu/cpu3/cpufreq/scaling_governor
      - cat /sys/devices/system/cpu/cpufreq/boost

  cpuseemax:
    desc: Print per-CPU scaling_max_freq values
    cmds:
      - cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_max_freq

  cpuseegov:
    desc: Print per-CPU scaling governors
    cmds:
      - cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor

  cpuseetrubo:
    desc: Print CPU turbo/boost setting
    cmds:
      - cat /sys/devices/system/cpu/cpufreq/boost

  cpurestart:
    desc: Restart cpufrequtils service
    cmds:
      - systemctl restart cpufrequtils

  offturbo:
    desc: Disable CPU turbo boost and install rc.local helper
    cmds:
      - echo "0" | tee /sys/devices/system/cpu/cpufreq/boost
      - cp rc.local /etc/rc.local
